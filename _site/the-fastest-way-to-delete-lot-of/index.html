<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>The fastest way to delete a lot of records in a TSQL table. – popped.io</title> <meta name="description" content="A collection of my security research, random projects and attempts to amuse."> <meta name="keywords" content="Drop, Row, Table, Records, T-SQL, Select, Alter, Schema, Database, Delete, TSQL, Fast, Column"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/me.png"> <meta name="twitter:title" content="The fastest way to delete a lot of records in a TSQL table."> <meta name="twitter:description" content="This isn’t Security related research, but it could come in handy for anyone looking to delete a large amount of data from TSQL databases."> <meta name="twitter:site" content="@hackerjiv"> <meta name="twitter:creator" content="@hackerjiv"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="The fastest way to delete a lot of records in a TSQL table."> <meta property="og:description" content="This isn’t Security related research, but it could come in handy for anyone looking to delete a large amount of data from TSQL databases."> <meta property="og:url" content="http://localhost:4000/the-fastest-way-to-delete-lot-of/"> <meta property="og:site_name" content="popped.io"> <meta property="og:image" content="http://localhost:4000/assets/img/me.png"> <link rel="canonical" href="http://localhost:4000/the-fastest-way-to-delete-lot-of/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="popped.io Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png"> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <!-- Begin Jekyll SEO tag v2.2.3 --> <title>The fastest way to delete a lot of records in a TSQL table. | popped.io</title> <meta property="og:title" content="The fastest way to delete a lot of records in a TSQL table."> <meta name="author" content="Sanjiv Kawa"> <meta property="og:locale" content="en_US"> <meta name="description" content="This isn’t Security related research, but it could come in handy for anyone looking to delete a large amount of data from TSQL databases."> <meta property="og:description" content="This isn’t Security related research, but it could come in handy for anyone looking to delete a large amount of data from TSQL databases."> <link rel="canonical" href="http://localhost:4000/the-fastest-way-to-delete-lot-of/"> <meta property="og:url" content="http://localhost:4000/the-fastest-way-to-delete-lot-of/"> <meta property="og:site_name" content="popped.io"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2013-10-09T23:44:00-04:00"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@Sanjiv Kawa"> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"BlogPosting","headline":"The fastest way to delete a lot of records in a TSQL table.","author":{"@type":"Person","name":"Sanjiv Kawa"},"datePublished":"2013-10-09T23:44:00-04:00","dateModified":"2013-10-09T23:44:00-04:00","description":"This isn’t Security related research, but it could come in handy for anyone looking to delete a large amount of data from TSQL databases.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/me.png"},"name":"Sanjiv Kawa"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/the-fastest-way-to-delete-lot-of/"},"url":"http://localhost:4000/the-fastest-way-to-delete-lot-of/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/me.png" alt="popped.io photo" class="author-photo"> <h4>popped.io</h4> <p>A collection of my security research, random projects and attempts to amuse.</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:sanjiv@popped.io" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/hackerjiv" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/sanjivkawa" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/skahwah" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>The fastest way to delete a lot of records in a TSQL table.</h1> <h4>09 Oct 2013</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~3 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>This isn’t Security related research, but it could come in handy for anyone looking to delete a large amount of data from TSQL databases.</p> <p>I recently had a task where I had to delete well over 50,000 rows based on a common column value within a TSQL database. Originally I thought that a simple conditional DELETE statement would do the trick, for example:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">delete</span> <span class="nt">from</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE1</span> <span class="nt">where</span> <span class="nt">DATE</span> <span class="nt">between</span> <span class="nt">2005</span> <span class="nt">and</span> <span class="nt">2012</span></code></pre></figure> <p>The issue here is that the database could be so bogged down that the DELETE query could take greater than 20 seconds to remove a single record. This means it would take 11.5 days to delete 50,000 records on a single looping query. No exaggeration.</p> <p>I decided that the least expensive way to do this (in terms of time) would be to do the following:</p> <p>Always back up the database, do it twice.</p> <p>Create a second table (TABLE2) that has the exact same schema as the original table (TABLE1). This can be done pretty easily using the CREATE TO script built into MS SQL Management Studio.</p> <p>Move all the data we want, lets say records newer than 2012, from TABLE1 into TABLE2 using a pretty standard SELECT statement. You might run into some errors here if the Identity property is set on the table. So first, lets figure out if identity is set on any tables in the database:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">select</span> <span class="nt">column_name</span><span class="o">,</span> <span class="nt">table_name</span> <span class="nt">from</span> <span class="nt">INFORMATION_SCHEMA</span><span class="nc">.COLUMNS</span>
<span class="nt">where</span> <span class="nt">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s2">'dbo'</span>
<span class="nt">and</span> <span class="nt">COLUMNPROPERTY</span> <span class="o">(</span><span class="nt">object_id</span><span class="o">(</span><span class="nt">table_name</span><span class="o">),</span> <span class="nt">column_name</span><span class="o">,</span> <span class="s2">'isIdentity'</span><span class="o">)</span> <span class="o">=</span> <span class="nt">1</span>
<span class="nt">order</span> <span class="nt">by</span> <span class="nt">table_name</span></code></pre></figure> <p>If Identity isn’t set, we can move all the rows that are newer than 2012 from TABLE1 to TABLE2:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">insert</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE2</span>
<span class="nt">select</span> <span class="o">*</span> <span class="nt">from</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE1</span>
<span class="nt">where</span> <span class="nt">DATE</span> <span class="nt">between</span> <span class="s2">'2012-01-01'</span> <span class="nt">and</span> <span class="s2">'2099-01-01'</span></code></pre></figure> <p>Find all the dependant Foreign Key mappings that TABLE1 has and make sure you record the name(s) of them. Thanks <a href="http://stackoverflow.com/questions/483193/how-can-i-list-all-foreign-keys-referencing-a-given-table-in-sql-server">stackoverflow</a>:</p> <p>This displays all the other tables that have Foreign Keys that rely on TABLE1:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">select</span> <span class="nt">t</span><span class="nc">.name</span> <span class="nt">as</span> <span class="nt">TableWithForeignKey</span><span class="o">,</span> <span class="nt">fk</span><span class="nc">.constraint_column_id</span> <span class="nt">as</span> <span class="nt">FK_PartNo</span> <span class="o">,</span> <span class="nt">c</span><span class="nc">.name</span> <span class="nt">as</span> <span class="nt">ForeignKeyColumn</span>
<span class="nt">from</span> <span class="nt">sys</span><span class="nc">.foreign_key_columns</span> <span class="nt">as</span> <span class="nt">fk</span>
<span class="nt">inner</span> <span class="nt">join</span> <span class="nt">sys</span><span class="nc">.tables</span> <span class="nt">as</span> <span class="nt">t</span> <span class="nt">on</span> <span class="nt">fk</span><span class="nc">.parent_object_id</span> <span class="o">=</span> <span class="nt">t</span><span class="nc">.object_id</span>
<span class="nt">inner</span> <span class="nt">join</span> <span class="nt">sys</span><span class="nc">.columns</span> <span class="nt">as</span> <span class="nt">c</span> <span class="nt">on</span> <span class="nt">fk</span><span class="nc">.parent_object_id</span> <span class="o">=</span> <span class="nt">c</span><span class="nc">.object_id</span> <span class="nt">and</span> <span class="nt">fk</span><span class="nc">.parent_column_id</span> <span class="o">=</span> <span class="nt">c</span><span class="nc">.column_id</span>
<span class="nt">where</span> <span class="nt">fk</span><span class="nc">.referenced_object_id</span> <span class="o">=</span> <span class="o">(</span><span class="nt">select</span> <span class="nt">object_id</span> <span class="nt">from</span> <span class="nt">sys</span><span class="nc">.tables</span> <span class="nt">where</span> <span class="nt">name</span> <span class="o">=</span> <span class="s2">'TABLE1'</span><span class="o">)</span>
<span class="nt">order</span> <span class="nt">by</span> <span class="nt">TableWithForeignKey</span><span class="o">,</span> <span class="nt">FK_PartNo</span></code></pre></figure> <p>This displays the Foreign Key names that are within the tables that have Foreign Keys which rely on TABLE1.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">select</span> <span class="nt">distinct</span> <span class="nt">name</span> <span class="nt">from</span> <span class="nt">sys</span><span class="nc">.objects</span> <span class="nt">where</span> <span class="nt">object_id</span> <span class="nt">in</span>
<span class="o">(</span>   <span class="nt">select</span> <span class="nt">fk</span><span class="nc">.constraint_object_id</span> <span class="nt">from</span> <span class="nt">sys</span><span class="nc">.foreign_key_columns</span> <span class="nt">as</span> <span class="nt">fk</span>
    <span class="nt">where</span> <span class="nt">fk</span><span class="nc">.referenced_object_id</span> <span class="o">=</span>
     <span class="o">(</span><span class="nt">select</span> <span class="nt">object_id</span> <span class="nt">from</span> <span class="nt">sys</span><span class="nc">.tables</span> <span class="nt">where</span> <span class="nt">name</span> <span class="o">=</span> <span class="s2">'TABLE1'</span><span class="o">)</span>
<span class="o">)</span></code></pre></figure> <p>Drop the Foreign Key associations on various dependant tables, then drop TABLE1.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">alter</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE3</span> <span class="nt">drop</span> <span class="nt">fk_TABLE3_TABLE1</span>

<span class="nt">alter</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE4</span> <span class="nt">drop</span> <span class="nt">fk_TABLE4_TABLE1</span>

<span class="nt">alter</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE5</span> <span class="nt">drop</span> <span class="nt">fk_TABLE5_TABLE1</span>

<span class="o">...</span>

<span class="nt">drop</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE1</span></code></pre></figure> <p>Recreate TABLE1 using the same schema as TABLE2 using the same CREATE TO script in step 1.</p> <p>Re-associate the Foreign Keys to the new TABLE1.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">alter</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE3</span> <span class="nt">with</span> <span class="nt">check</span> <span class="nt">add</span> <span class="nt">constraint</span> <span class="nt">fk_TABLE3_TABLE1</span> <span class="nt">foreign</span> <span class="nt">key</span><span class="o">([</span><span class="nt">ID</span><span class="o">])</span>
<span class="nt">references</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE1</span> <span class="o">([</span><span class="nt">ID</span><span class="o">])</span>
<span class="nt">on</span> <span class="nt">delete</span> <span class="nt">cascade</span>
<span class="nt">go</span>

<span class="nt">alter</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE3</span> <span class="nt">check</span> <span class="nt">constraint</span> <span class="nt">fk_TABLE3_TABLE1</span>
<span class="nt">go</span>

<span class="o">...</span></code></pre></figure> <p>Copy all of the data from TABLE2 to TABLE1. Then drop TABLE2.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">insert</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE2</span>
<span class="nt">select</span> <span class="o">*</span> <span class="nt">from</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE1</span>
<span class="nt">where</span> <span class="nt">DATE</span> <span class="nt">between</span> <span class="s2">'2012-01-01'</span> <span class="nt">and</span> <span class="s2">'2099-01-01'</span>
<span class="nt">go</span>

<span class="nt">drop</span> <span class="nt">table</span> <span class="nt">DBNAME</span><span class="nc">.DBO.TABLE2</span></code></pre></figure> <p>The query speeds were significantly faster, depending on your database size this can take less than an hour to do. It is much better than waiting 11.5 days and hypothetically causing downtime for a clients critical application.</p> <p>Hope this helps.</p> <div class="entry-meta">  <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Drop" title="Pages tagged Drop" class="tag"><span class="term">Drop</span></a><a href="http://localhost:4000/tags/#Row" title="Pages tagged Row" class="tag"><span class="term">Row</span></a><a href="http://localhost:4000/tags/#Table" title="Pages tagged Table" class="tag"><span class="term">Table</span></a><a href="http://localhost:4000/tags/#Records" title="Pages tagged Records" class="tag"><span class="term">Records</span></a><a href="http://localhost:4000/tags/#T-SQL" title="Pages tagged T-SQL" class="tag"><span class="term">T-SQL</span></a><a href="http://localhost:4000/tags/#Select" title="Pages tagged Select" class="tag"><span class="term">Select</span></a><a href="http://localhost:4000/tags/#Alter" title="Pages tagged Alter" class="tag"><span class="term">Alter</span></a><a href="http://localhost:4000/tags/#Schema" title="Pages tagged Schema" class="tag"><span class="term">Schema</span></a><a href="http://localhost:4000/tags/#Database" title="Pages tagged Database" class="tag"><span class="term">Database</span></a><a href="http://localhost:4000/tags/#Delete" title="Pages tagged Delete" class="tag"><span class="term">Delete</span></a><a href="http://localhost:4000/tags/#TSQL" title="Pages tagged TSQL" class="tag"><span class="term">TSQL</span></a><a href="http://localhost:4000/tags/#Fast" title="Pages tagged Fast" class="tag"><span class="term">Fast</span></a><a href="http://localhost:4000/tags/#Column" title="Pages tagged Column" class="tag"><span class="term">Column</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/the-fastest-way-to-delete-lot-of/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/the-fastest-way-to-delete-lot-of/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/the-fastest-way-to-delete-lot-of/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-85516324-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <script type="text/javascript"> var disqus_shortname = 'sanjivkawa'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  </body>
</html>
