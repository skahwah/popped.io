<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems – popped.io</title> <meta name="description" content="A collection of my security research, random projects and attempts to amuse."> <meta name="keywords" content="Monitoring, Linux, OSSEC, Security, Alerts, Postfix"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/me.png"> <meta name="twitter:title" content="Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems"> <meta name="twitter:description" content="A few months ago I was experimenting with receiving custom alerts from my internet facing *NIX boxes. Some of the things I wanted to monitor in real-time (or close enough to) were successful SSH login attempts, sudo/privilege escalation alerts and new file creations. I wrote a few shell scripts that handled this for me and it ended up working pretty well."> <meta name="twitter:site" content="@hackerjiv"> <meta name="twitter:creator" content="@hackerjiv"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems"> <meta property="og:description" content="A few months ago I was experimenting with receiving custom alerts from my internet facing *NIX boxes. Some of the things I wanted to monitor in real-time (or close enough to) were successful SSH login attempts, sudo/privilege escalation alerts and new file creations. I wrote a few shell scripts that handled this for me and it ended up working pretty well."> <meta property="og:url" content="http://localhost:4000/using-postfix-and-ossec-to-monitor-your/"> <meta property="og:site_name" content="popped.io"> <meta property="og:image" content="http://localhost:4000/assets/img/me.png"> <link rel="canonical" href="http://localhost:4000/using-postfix-and-ossec-to-monitor-your/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="popped.io Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png"> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <!-- Begin Jekyll SEO tag v2.2.3 --> <title>Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems | popped.io</title> <meta property="og:title" content="Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems"> <meta name="author" content="Sanjiv Kawa"> <meta property="og:locale" content="en_US"> <meta name="description" content="A few months ago I was experimenting with receiving custom alerts from my internet facing *NIX boxes. Some of the things I wanted to monitor in real-time (or close enough to) were successful SSH login attempts, sudo/privilege escalation alerts and new file creations. I wrote a few shell scripts that handled this for me and it ended up working pretty well."> <meta property="og:description" content="A few months ago I was experimenting with receiving custom alerts from my internet facing *NIX boxes. Some of the things I wanted to monitor in real-time (or close enough to) were successful SSH login attempts, sudo/privilege escalation alerts and new file creations. I wrote a few shell scripts that handled this for me and it ended up working pretty well."> <link rel="canonical" href="http://localhost:4000/using-postfix-and-ossec-to-monitor-your/"> <meta property="og:url" content="http://localhost:4000/using-postfix-and-ossec-to-monitor-your/"> <meta property="og:site_name" content="popped.io"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2015-11-06T19:52:00-05:00"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@Sanjiv Kawa"> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"BlogPosting","headline":"Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems","author":{"@type":"Person","name":"Sanjiv Kawa"},"datePublished":"2015-11-06T19:52:00-05:00","dateModified":"2015-11-06T19:52:00-05:00","description":"A few months ago I was experimenting with receiving custom alerts from my internet facing *NIX boxes. Some of the things I wanted to monitor in real-time (or close enough to) were successful SSH login attempts, sudo/privilege escalation alerts and new file creations. I wrote a few shell scripts that handled this for me and it ended up working pretty well.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/me.png"},"name":"Sanjiv Kawa"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/using-postfix-and-ossec-to-monitor-your/"},"url":"http://localhost:4000/using-postfix-and-ossec-to-monitor-your/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/me.png" alt="popped.io photo" class="author-photo"> <h4>popped.io</h4> <p>A collection of my security research, random projects and attempts to amuse.</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:sanjiv@popped.io" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/hackerjiv" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/sanjivkawa" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/skahwah" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Using Postfix and OSSEC to Monitor Your VPS or Production *NIX Systems</h1> <h4>06 Nov 2015</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~9 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>A few months ago I was experimenting with receiving custom alerts from my internet facing *NIX boxes. Some of the things I wanted to monitor in real-time (or close enough to) were successful SSH login attempts, sudo/privilege escalation alerts and new file creations. I wrote a few shell scripts that handled this for me and it ended up working pretty well.</p> <p>Last week I started looking tools that handle monitoring and alerting and stumbled upon <a href="http://www.ossec.net/">OSSEC</a>. OSSEC encompasses everything I was looking to receive alerts for and more. For those of you who aren’t familiar with OSSEC, it’s an <em>“Open Source Host-based Intrusion Detection System that performs log analysis, file integrity checking, policy monitoring, rootkit detection, real-time alerting and active response.”</em></p> <p>After playing around with OSSEC for a few days now I’ve come to a pretty solid conclusion that it’s going to be a regular tool that will be featuring in my *NIX builds from now on.</p> <p>I decided to put together this guide to help out people who want a little more insight into what is happening on their VPS or production *NIX systems.</p> <h1 id="0-pre-requisites">0. Pre-requisites</h1> <p>For this guide in particular you’re going to need:</p> <ul> <li>A VPS running Ubuntu</li> <li>DNS configured to point to the public IP address of the VPS.</li> <li>A mail account with Google or a similar provider.</li> </ul> <p>Throughout this guide I’ll refer to the VPS as <code class="highlighter-rouge">sub.domain.com</code> and the mail account as <code class="highlighter-rouge">me@gmail.com</code>.</p> <h1 id="1-installing-and-configuring-postfix-as-a-send-only-smtp-server">1. Installing and Configuring Postfix as a Send-Only SMTP Server</h1> <p>Postfix is going to handle all of the SMTP relaying for us, you don’t need to open any TCP or UDP ingress ports.</p> <p>First, make sure that the hostname of your VPS is configured correctly.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">hostname</span> <span class="nt">sub</span><span class="nc">.domain.com</span></code></pre></figure> <p>Next, update the box and install mailutils</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">apt-get</span> <span class="nt">update</span> <span class="o">&amp;&amp;</span> <span class="nt">sudo</span> <span class="nt">apt-get</span> <span class="nt">install</span> <span class="nt">mailutils</span> <span class="nt">-y</span></code></pre></figure> <p>As the mailtutils installation progresses, you will reach a point where you will need to specify the Postfix configuration type. Select <code class="highlighter-rouge">Internet Site</code>.</p> <figure> <center> <img src="https://3.bp.blogspot.com/-Onpr7pUuVPM/VjwTBD5EgaI/AAAAAAAAB8o/Iz-Y5Xj513Q/s400/Screen%2BShot%2B2015-11-05%2Bat%2B7.38.59%2BPM.png"> </center> </figure> <p>You should then be prompted by the Postfix configuration agent to enter the mail name for the system.</p> <figure> <center> <img src="https://3.bp.blogspot.com/-zOQ5h7X44iE/VjwYJ0KL5HI/AAAAAAAAB88/CbxfrrRNm-0/s1600/Screen%2BShot%2B2015-11-05%2Bat%2B8.01.32%2BPM.png"> </center> </figure> <p>Next, you’ll need to edit the main configuration file for postfix to ensure that the internet interface is set as the localhost. This should be the second last line of the file:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">cp</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">postfix</span><span class="o">/</span><span class="nt">main</span><span class="nc">.cf</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">postfix</span><span class="o">/</span><span class="nt">main</span><span class="nc">.cf.bak</span>
<span class="nt">sudo</span> <span class="nt">vim</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">postfix</span><span class="o">/</span><span class="nt">main</span><span class="nc">.cf</span>

<span class="o">...</span>

<span class="err">#</span> <span class="nt">inet_interfaces</span> <span class="o">=</span> <span class="nt">all</span>
<span class="nt">inet_interfaces</span> <span class="o">=</span> <span class="nt">localhost</span>
<span class="nt">inet_protocols</span> <span class="o">=</span> <span class="nt">all</span></code></pre></figure> <p>That should be all of the configurations needed to configure Postfix as a send-only SMTP server. Restart Postfix and send a test email to your Google mail account by running the following mail commands:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">service</span> <span class="nt">postfix</span> <span class="nt">restart</span>
<span class="nt">echo</span> <span class="s1">"This is the body of the email"</span> <span class="o">|</span> <span class="nt">mail</span> <span class="nt">-s</span> <span class="s1">"This is the subject line"</span> <span class="nt">me</span><span class="k">@gmail</span><span class="p">.</span><span class="n">com</span></code></pre></figure> <p>You should receive an email similar to the following:</p> <figure> <center> <img src="https://2.bp.blogspot.com/-0MUDj-zjG4M/VjwZvhRoj7I/AAAAAAAAB9I/dhxZZlL6CQw/s400/1.png"> </center> </figure> <p>Next, let’s set up some mail aliases so that whenever users such as “root” or “ubuntu” receive mail, it is forwarded to your Google mail account.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">vim</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">aliases</span></code></pre></figure> <p>Append the following lines to /etc/aliases:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">root</span><span class="o">:</span>          <span class="nt">me</span><span class="k">@gmail</span><span class="p">.</span><span class="n">com</span>
<span class="n">ubuntu</span><span class="p">:</span>        <span class="n">me</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span></code></pre></figure> <p>Commit the changes to /etc/aliases and send a test email to “root” and “ubuntu” by running the following mail commands:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">newaliases</span>
<span class="nt">echo</span> <span class="s1">"This is the body of the email from root"</span> <span class="o">|</span> <span class="nt">mail</span> <span class="nt">-s</span> <span class="s1">"This is the subject line from root"</span> <span class="nt">root</span>
<span class="nt">echo</span> <span class="s1">"This is the body of the email from ubuntu"</span> <span class="o">|</span> <span class="nt">mail</span> <span class="nt">-s</span> <span class="s1">"This is the subject line from ubuntu"</span> <span class="nt">ubuntu</span></code></pre></figure> <p>You should receive an email similar to the following:</p> <figure> <center> <img src="https://2.bp.blogspot.com/-weo-LwvM5z8/VjwcLjZXQ3I/AAAAAAAAB9U/55jxjQAgXiY/s1600/2.png"> </center> </figure> <h1 id="2-installing-ossec">2. Installing OSSEC</h1> <p>First, you’ll need to update and install some essential packages and notification tools that are required for real-time alerting to work with OSSEC.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">apt-get</span> <span class="nt">update</span> <span class="o">&amp;&amp;</span> <span class="nt">sudo</span> <span class="nt">apt-get</span> <span class="nt">install</span> <span class="nt">build-essential</span> <span class="nt">inotify-tools</span></code></pre></figure> <p>Next, download and install OSSEC.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">cd</span> <span class="o">&amp;&amp;</span> <span class="nt">wget</span> <span class="nt">-U</span> <span class="nt">ossec</span> <span class="nt">https</span><span class="o">://</span><span class="nt">bintray</span><span class="nc">.com</span><span class="o">/</span><span class="nt">artifact</span><span class="o">/</span><span class="nt">download</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">ossec-hids</span><span class="o">/</span><span class="nt">ossec-hids-2</span><span class="nc">.8.3.tar.gz</span>
<span class="nt">tar</span> <span class="nt">-zxf</span> <span class="nt">ossec-hids-2</span><span class="nc">.8.3.tar.gz</span> <span class="o">&amp;&amp;</span> <span class="nt">cd</span> <span class="nt">ossec-hids-2</span><span class="nc">.8.3</span>
<span class="nt">sudo</span> <span class="o">./</span><span class="nt">install</span><span class="nc">.sh</span></code></pre></figure> <p>As you are running through the installation, ensure that you enter the following when prompted:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">1-</span> <span class="nt">What</span> <span class="nt">kind</span> <span class="nt">of</span> <span class="nt">installation</span> <span class="nt">do</span> <span class="nt">you</span> <span class="nt">want</span> <span class="o">(</span><span class="nt">server</span><span class="o">,</span> <span class="nt">agent</span><span class="o">,</span> <span class="nt">local</span><span class="o">,</span> <span class="nt">hybrid</span> <span class="nt">or</span> <span class="nt">help</span><span class="o">)?</span> <span class="nt">local</span>

  <span class="nt">-</span> <span class="nt">Local</span> <span class="nt">installation</span> <span class="nt">chosen</span><span class="o">.</span>

<span class="nt">2-</span> <span class="nt">Setting</span> <span class="nt">up</span> <span class="nt">the</span> <span class="nt">installation</span> <span class="nt">environment</span><span class="o">.</span>

 <span class="nt">-</span> <span class="nt">Choose</span> <span class="nt">where</span> <span class="nt">to</span> <span class="nt">install</span> <span class="nt">the</span> <span class="nt">OSSEC</span> <span class="nt">HIDS</span> <span class="o">[/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">]:</span>

    <span class="nt">-</span> <span class="nt">Installation</span> <span class="nt">will</span> <span class="nt">be</span> <span class="nt">made</span> <span class="nt">at</span>  <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span> <span class="o">.</span>

<span class="nt">3-</span> <span class="nt">Configuring</span> <span class="nt">the</span> <span class="nt">OSSEC</span> <span class="nt">HIDS</span><span class="o">.</span>

  <span class="nt">3</span><span class="nc">.1-</span> <span class="nt">Do</span> <span class="nt">you</span> <span class="nt">want</span> <span class="nt">e-mail</span> <span class="nt">notification</span><span class="o">?</span> <span class="o">(</span><span class="nt">y</span><span class="o">/</span><span class="nt">n</span><span class="o">)</span> <span class="o">[</span><span class="nt">y</span><span class="o">]:</span> <span class="nt">y</span>
   <span class="nt">-</span> <span class="nt">What</span><span class="err">'</span><span class="nt">s</span> <span class="nt">your</span> <span class="nt">e-mail</span> <span class="nt">address</span><span class="o">?</span> <span class="nt">root</span><span class="k">@localhost</span>      

   <span class="n">-</span> <span class="n">We</span> <span class="n">found</span> <span class="n">your</span> <span class="n">SMTP</span> <span class="n">server</span> <span class="n">as</span><span class="p">:</span> <span class="m">127.0.0.1</span>
   <span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="p">]:</span> <span class="n">y</span>

   <span class="n">---</span> <span class="n">Using</span> <span class="n">SMTP</span> <span class="n">server</span><span class="p">:</span>  <span class="m">127.0.0.1</span>

  <span class="m">3.2</span><span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">integrity</span> <span class="n">check</span> <span class="n">daemon</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="p">]:</span> <span class="n">y</span>

   <span class="n">-</span> <span class="n">Running</span> <span class="n">syscheck</span> <span class="p">(</span><span class="n">integrity</span> <span class="n">check</span> <span class="n">daemon</span><span class="p">).</span>

  <span class="m">3.3</span><span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">rootkit</span> <span class="n">detection</span> <span class="n">engine</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="p">]:</span> <span class="n">y</span>

   <span class="n">-</span> <span class="n">Running</span> <span class="n">rootcheck</span> <span class="p">(</span><span class="n">rootkit</span> <span class="n">detection</span><span class="p">).</span>

  <span class="m">3.4</span><span class="n">-</span> <span class="n">Active</span> <span class="n">response</span> <span class="n">allows</span> <span class="n">you</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">a</span> <span class="n">specific</span>
       <span class="n">command</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">events</span> <span class="n">received</span><span class="p">.</span> <span class="n">For</span> <span class="n">example</span><span class="p">,</span>
       <span class="n">you</span> <span class="n">can</span> <span class="nb">block</span> <span class="n">an</span> <span class="n">IP</span> <span class="n">address</span> <span class="n">or</span> <span class="n">disable</span> <span class="n">access</span> <span class="n">for</span>
       <span class="n">a</span> <span class="n">specific</span> <span class="n">user</span><span class="p">.</span>  
       <span class="n">More</span> <span class="n">information</span> <span class="n">at</span><span class="p">:</span>
       <span class="n">http</span><span class="p">://</span><span class="n">www</span><span class="p">.</span><span class="n">ossec</span><span class="p">.</span><span class="n">net</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">manual</span><span class="p">.</span><span class="n">html</span><span class="m">#ac</span><span class="n">tive-response</span>

   <span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">active</span> <span class="n">response</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="p">]:</span> <span class="n">y</span>

     <span class="n">-</span> <span class="n">Active</span> <span class="n">response</span> <span class="n">enabled</span><span class="p">.</span>

   <span class="n">-</span> <span class="n">By</span> <span class="nb">default</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">host-deny</span> <span class="n">and</span> <span class="n">the</span>
     <span class="n">firewall-drop</span> <span class="n">responses</span><span class="p">.</span> <span class="n">The</span> <span class="n">first</span> <span class="n">one</span> <span class="n">will</span> <span class="n">add</span>
     <span class="n">a</span> <span class="n">host</span> <span class="n">to</span> <span class="n">the</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">hosts</span><span class="p">.</span><span class="n">deny</span> <span class="n">and</span> <span class="n">the</span> <span class="n">second</span> <span class="n">one</span>
     <span class="n">will</span> <span class="nb">block</span> <span class="n">the</span> <span class="n">host</span> <span class="n">on</span> <span class="n">iptables</span> <span class="p">(</span><span class="n">if</span> <span class="n">linux</span><span class="p">)</span> <span class="n">or</span> <span class="n">on</span>
     <span class="n">ipfilter</span> <span class="p">(</span><span class="n">if</span> <span class="n">Solaris</span><span class="p">,</span> <span class="n">FreeBSD</span> <span class="n">or</span> <span class="n">NetBSD</span><span class="p">).</span>
   <span class="n">-</span> <span class="n">They</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">SSHD</span> <span class="n">brute</span> <span class="n">force</span> <span class="n">scans</span><span class="p">,</span>
     <span class="n">portscans</span> <span class="n">and</span> <span class="n">some</span> <span class="n">other</span> <span class="n">forms</span> <span class="n">of</span> <span class="n">attacks</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span>
     <span class="n">also</span> <span class="n">add</span> <span class="n">them</span> <span class="n">to</span> <span class="nb">block</span> <span class="n">on</span> <span class="n">snort</span> <span class="n">events</span><span class="p">,</span> <span class="n">for</span> <span class="n">example</span><span class="p">.</span>

   <span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">firewall-drop</span> <span class="n">response</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="p">]:</span> <span class="n">y</span>

     <span class="n">-</span> <span class="n">firewall-drop</span> <span class="n">enabled</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="n">for</span> <span class="n">levels</span> <span class="err">&gt;=</span> <span class="m">6</span>

   <span class="n">-</span> <span class="n">Default</span> <span class="no">white</span> <span class="n">list</span> <span class="n">for</span> <span class="n">the</span> <span class="n">active</span> <span class="n">response</span><span class="p">:</span>
      <span class="n">-</span> <span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span>

   <span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">add</span> <span class="n">more</span> <span class="n">IPs</span> <span class="n">to</span> <span class="n">the</span> <span class="no">white</span> <span class="n">list</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span><span class="err">?</span> <span class="p">[</span><span class="n">n</span><span class="p">]:</span> <span class="n">n</span>

  <span class="m">3.5</span><span class="n">-</span> <span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">remote</span> <span class="n">syslog</span> <span class="p">(</span><span class="n">port</span> <span class="m">514</span> <span class="n">udp</span><span class="p">)</span><span class="err">?</span> <span class="p">(</span><span class="n">y</span><span class="p">/</span><span class="n">n</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="p">]:</span> <span class="n">y</span>

   <span class="n">-</span> <span class="n">Remote</span> <span class="n">syslog</span> <span class="n">enabled</span><span class="p">.</span>

  <span class="m">3.6</span><span class="n">-</span> <span class="n">Setting</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">the</span> <span class="n">following</span> <span class="n">logs</span><span class="p">:</span>
    <span class="n">--</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">auth</span><span class="p">.</span><span class="n">log</span>
    <span class="n">--</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">syslog</span>
    <span class="n">--</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">dpkg</span><span class="p">.</span><span class="n">log</span>

 <span class="n">-</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">monitor</span> <span class="n">any</span> <span class="n">other</span> <span class="n">file</span><span class="p">,</span> <span class="n">just</span> <span class="n">change</span>
   <span class="n">the</span> <span class="n">ossec</span><span class="p">.</span><span class="n">conf</span> <span class="n">and</span> <span class="n">add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">localfile</span> <span class="n">entry</span><span class="p">.</span>
   <span class="n">Any</span> <span class="n">questions</span> <span class="n">about</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">can</span> <span class="n">be</span> <span class="n">answered</span>
   <span class="n">by</span> <span class="n">visiting</span> <span class="n">us</span> <span class="n">online</span> <span class="n">at</span> <span class="n">http</span><span class="p">://</span><span class="n">www</span><span class="p">.</span><span class="n">ossec</span><span class="p">.</span><span class="n">net</span><span class="p">.</span></code></pre></figure> <p>Check the status of OSSEC and ensure that it is <strong>not</strong> running:</p> <p>sudo /var/ossec/bin/ossec-control status</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">ossec-monitord</span> <span class="nt">not</span> <span class="nt">running</span><span class="o">...</span>
<span class="nt">ossec-logcollector</span> <span class="nt">not</span> <span class="nt">running</span><span class="o">...</span>
<span class="nt">ossec-syscheckd</span> <span class="nt">not</span> <span class="nt">running</span><span class="o">...</span>
<span class="nt">ossec-analysisd</span> <span class="nt">not</span> <span class="nt">running</span><span class="o">...</span>
<span class="nt">ossec-maild</span> <span class="nt">not</span> <span class="nt">running</span><span class="o">...</span>
<span class="nt">ossec-execd</span> <span class="nt">not</span> <span class="nt">running</span><span class="o">...</span></code></pre></figure> <h1 id="3-configuring-ossec">3. Configuring OSSEC</h1> <p>Most if not all of OSSEC’s files are contained within <code class="highlighter-rouge">/var/ossec</code>.</p> <p>OSSEC binaries are in <code class="highlighter-rouge">/var/ossec/bin</code> Configuration files are in <code class="highlighter-rouge">/var/ossec/etc</code> Rules are contained within <code class="highlighter-rouge">/var/ossec/rules</code></p> <p>The OSSEC configuration file is located at <code class="highlighter-rouge">/var/ossec/etc/ossec.conf</code>. This holds all settings broken down into several XML elements.</p> <p>The first thing you’ll need to do is create a backup copy of the OSSEC main configuration file.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">-i</span>
<span class="nt">cd</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">etc</span><span class="o">/</span>
<span class="nt">cp</span> <span class="nt">ossec</span><span class="nc">.conf</span> <span class="nt">ossec</span><span class="nc">.conf.bak</span>
<span class="nt">vim</span> <span class="nt">ossec</span><span class="nc">.conf</span></code></pre></figure> <p>After opening and scrolling through the configuration file, you will notice that there is a <code class="highlighter-rouge">&lt;frequency&gt;</code> element nested under <code class="highlighter-rouge">&lt;syscheck&gt;</code>. This should contain a value of <code class="highlighter-rouge">79200</code>. This value refers to how many times <code class="highlighter-rouge">&lt;syscheck&gt;</code> is executed within a certain amount of seconds. <code class="highlighter-rouge">&lt;syscheck&gt;</code> is responsible for scanning the file system to identify new files. For testing purposes you can set the value of <code class="highlighter-rouge">&lt;frequency&gt;</code> to <code class="highlighter-rouge">60</code>, which is 60 seconds. After you feel that testing has concluded you can set this value back to <code class="highlighter-rouge">79200</code> which is 22 hours or <code class="highlighter-rouge">28800</code> which is 8 hours.</p> <p><code class="highlighter-rouge">&lt;frequency&gt;60&lt;/frequency&gt; </code> Personally, I like to be notified when new files are created, to configure this option, navigate down to the <code class="highlighter-rouge">&lt;syscheck&gt; </code>section and add the following lines under the <code class="highlighter-rouge">&lt;frequency&gt;</code> element.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="o">&lt;!</span><span class="nt">--</span> <span class="nt">Added</span><span class="o">:</span> <span class="nt">alert_new_files</span> <span class="nt">to</span> <span class="nt">send</span> <span class="nt">a</span> <span class="nt">notification</span> <span class="nt">each</span> <span class="nt">time</span> <span class="nt">a</span> <span class="nt">new</span> <span class="nt">file</span> <span class="nt">is</span> <span class="nt">created</span> <span class="nt">--</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nt">alert_new_files</span><span class="o">&gt;</span><span class="nt">yes</span><span class="o">&lt;/</span><span class="nt">alert_new_files</span><span class="o">&gt;</span></code></pre></figure> <p>By default, OSSEC monitors the following directories and nested files which are defined in the <code class="highlighter-rouge">&lt;directories&gt;</code> element.</p> <p><code class="highlighter-rouge">/etc</code><br> <code class="highlighter-rouge">/usr/bin</code><br> <code class="highlighter-rouge">/usr/sbin</code><br> <code class="highlighter-rouge">/bin</code><br> <code class="highlighter-rouge">/sbin</code><br></p> <p>You can enable realtime monitoring on these directories by adding the <code class="highlighter-rouge">report_changes</code> and <code class="highlighter-rouge">realtime</code> attributes and corresponding <code class="highlighter-rouge">yes</code> values within the <code class="highlighter-rouge">&lt;directories&gt;</code> element.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="o">&lt;</span><span class="nt">directories</span> <span class="nt">report_changes</span><span class="o">=</span><span class="s1">"yes"</span> <span class="nt">realtime</span><span class="o">=</span><span class="s1">"yes"</span> <span class="nt">check_all</span><span class="o">=</span><span class="s1">"yes"</span><span class="o">&gt;/</span><span class="nt">etc</span><span class="o">,/</span><span class="nt">usr</span><span class="o">/</span><span class="nt">bin</span><span class="o">,/</span><span class="nt">usr</span><span class="o">/</span><span class="nt">sbin</span><span class="o">&lt;/</span><span class="nt">directories</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nt">directories</span> <span class="nt">report_changes</span><span class="o">=</span><span class="s1">"yes"</span> <span class="nt">realtime</span><span class="o">=</span><span class="s1">"yes"</span> <span class="nt">check_all</span><span class="o">=</span><span class="s1">"yes"</span><span class="o">&gt;/</span><span class="nt">bin</span><span class="o">,/</span><span class="nt">sbin</span><span class="o">&lt;/</span><span class="nt">directories</span><span class="o">&gt;</span></code></pre></figure> <p>I would recommend identifying key areas of your file system that you want monitored before adding the directory in the <code class="highlighter-rouge">&lt;directories&gt;</code> element. For example, you wouldn’t want to monitor the <code class="highlighter-rouge">/var/logs </code>directory as files within this directory are continuously changing and you will receive emails from the server. OSSEC sends a maximum of 12 emails per hour (you can increase or decrease this). Some additional directories you may want to add are:</p> <p><code class="highlighter-rouge">/tmp</code><br> <code class="highlighter-rouge">/home/ubuntu</code><br> <code class="highlighter-rouge">/home/your-user-name</code><br> <code class="highlighter-rouge">/root</code><br></p> <p>If you have a CMS such as WordPress installed, these directories may be something you would want to include within OSSEC’s monitoring scope.</p> <p><code class="highlighter-rouge">/var/www/html/wp-content/uploads</code><br> <code class="highlighter-rouge">/var/www/html/wp-content/plugins</code><br></p> <p>The rules directory is located at <code class="highlighter-rouge">/var/ossec/rules/</code> and houses all of the rules which helps OSSEC determine its course of action for various behaviors that occur on the file system and exposed services.</p> <p>The last thing you’ll need to do is configure a local rule so that OSSEC sends an alert if a file change has been detected. Create a backup copy of the OSSEC <code class="highlighter-rouge">local_rules.xml</code> file</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">sudo</span> <span class="nt">cp</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">rules</span><span class="o">/</span><span class="nt">local_rules</span><span class="nc">.xml</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">rules</span><span class="o">/</span><span class="nt">local_rules</span><span class="nc">.xml.bak</span></code></pre></figure> <p>As we want to receive alerts for new files that are added to the system we can edit <code class="highlighter-rouge">/var/ossec/rules/local_rules.xml</code> and append the following before the <code class="highlighter-rouge">&lt;/group&gt;</code> tag:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="o">&lt;</span><span class="nt">rule</span> <span class="nt">id</span><span class="o">=</span><span class="s1">"554"</span> <span class="nt">level</span><span class="o">=</span><span class="s1">"7"</span> <span class="nt">overwrite</span><span class="o">=</span><span class="s1">"yes"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nt">category</span><span class="o">&gt;</span><span class="nt">ossec</span><span class="o">&lt;/</span><span class="nt">category</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nt">decoded_as</span><span class="o">&gt;</span><span class="nt">syscheck_new_entry</span><span class="o">&lt;/</span><span class="nt">decoded_as</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nt">description</span><span class="o">&gt;</span><span class="nt">File</span> <span class="nt">added</span> <span class="nt">to</span> <span class="nt">the</span> <span class="nt">system</span><span class="o">.&lt;/</span><span class="nt">description</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nt">group</span><span class="o">&gt;</span><span class="nt">syscheck</span><span class="o">,&lt;/</span><span class="nt">group</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nt">rule</span><span class="o">&gt;</span></code></pre></figure> <p>This should look similar to the following:</p> <figure> <center> <img src="https://3.bp.blogspot.com/-nDlbLPJ2XdM/Vj0-K3Hs0FI/AAAAAAAAB98/LDDLBvhznoQ/s1600/Screen%2BShot%2B2015-11-06%2Bat%2B4.53.40%2BPM.png"> </center> </figure> <p>After you have saved the <code class="highlighter-rouge">/var/ossec/rules/local_rules.xml</code> file, we can go ahead and start OSSEC.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">ossec-control</span> <span class="nt">start</span></code></pre></figure> <p>Starting OSSEC should look similar to the following:</p> <figure> <center> <img src="https://4.bp.blogspot.com/-npDBEFTqx_A/Vj0_EY02axI/AAAAAAAAB-E/oIZdhqQhcZQ/s1600/Screen%2BShot%2B2015-11-06%2Bat%2B4.57.30%2BPM.png"> </center> </figure> <p>You can check the status of OSSEC by executing the following command.</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">ossec-control</span> <span class="nt">status</span></code></pre></figure> <p>If you experience any issues trying to get OSSEC to start, check out the log file located at <code class="highlighter-rouge">/var/ossec/logs/ossec.log</code></p> <p>After starting OSSEC, you should receive an email similar to this:</p> <figure> <center> <img src="https://2.bp.blogspot.com/-UdcS0-3r11E/Vj1AAQRc1qI/AAAAAAAAB-M/6ESTSOSmFlg/s400/2.png"> </center> </figure> <p>Next, let’s create some test scenarios to make sure that alerting through OSSEC and Postfix is working correctly. Create a file named <code class="highlighter-rouge">ossec-test.conf</code> in <code class="highlighter-rouge">/etc</code> and write a string of text into it:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">cd</span> <span class="o">/</span><span class="nt">etc</span>
<span class="nt">vim</span> <span class="nt">ossec-test</span><span class="nc">.conf</span>
<span class="nt">write</span> <span class="nt">some</span> <span class="nt">text</span> <span class="nt">into</span> <span class="nt">ossec-test</span><span class="nc">.conf</span></code></pre></figure> <p>You should receive an alert similar to this:</p> <figure> <center> <img src="https://2.bp.blogspot.com/-pqxvPw9sC1A/Vj1Iam-wr_I/AAAAAAAAB-w/NLl8BX8UDjc/s400/4.png"> </center> </figure> <p>Exit your SSH session and log back into the server. You should receive an email similar to the following:</p> <figure> <center> <img src="https://4.bp.blogspot.com/-xfiJDYHXEQM/Vj1DcfIyRkI/AAAAAAAAB-Y/tAAGmbZvzbo/s400/3.png"> </center> </figure> <p>To wrap things up, make sure that you go back to your OSSEC configuration file and set the <code class="highlighter-rouge">&lt;frequency&gt;</code> value back to <code class="highlighter-rouge">79200</code> which is 22 hours or <code class="highlighter-rouge">28800</code> which is 8 hours. Restart OSSEC for the new configurations to be loaded:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">ossec</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">ossec-control</span> <span class="nt">restart</span></code></pre></figure> <p>Delete the test files that were created:</p> <figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">rm</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">ossec-test</span><span class="nc">.conf</span></code></pre></figure> <div class="entry-meta">  <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Monitoring" title="Pages tagged Monitoring" class="tag"><span class="term">Monitoring</span></a><a href="http://localhost:4000/tags/#Linux" title="Pages tagged Linux" class="tag"><span class="term">Linux</span></a><a href="http://localhost:4000/tags/#OSSEC" title="Pages tagged OSSEC" class="tag"><span class="term">OSSEC</span></a><a href="http://localhost:4000/tags/#Security" title="Pages tagged Security" class="tag"><span class="term">Security</span></a><a href="http://localhost:4000/tags/#Alerts" title="Pages tagged Alerts" class="tag"><span class="term">Alerts</span></a><a href="http://localhost:4000/tags/#Postfix" title="Pages tagged Postfix" class="tag"><span class="term">Postfix</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/using-postfix-and-ossec-to-monitor-your/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/using-postfix-and-ossec-to-monitor-your/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/using-postfix-and-ossec-to-monitor-your/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-85516324-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <script type="text/javascript"> var disqus_shortname = 'sanjivkawa'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  </body>
</html>
